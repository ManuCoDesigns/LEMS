// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SchoolType {
  PRIMARY
  SECONDARY
  HIGH_SCHOOL
  COLLEGE
  UNIVERSITY
  MIXED
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubjectCategory {
  CORE
  ELECTIVE
  CO_CURRICULAR
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  SICK
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String     @id @default(uuid())
  email    String     @unique
  password String
  role     UserRole   @default(STUDENT)
  status   UserStatus @default(PENDING)

  // Personal Information
  firstName   String
  lastName    String
  middleName  String?
  dateOfBirth DateTime?
  gender      Gender?
  phone       String?
  avatar      String?

  // Address
  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String?

  // Security
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  lastLogin       DateTime?
  refreshToken    String?

  // Relations
  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: SetNull)

  // Class Relations (Students)
  classId String?
  class   Class?  @relation("ClassStudents", fields: [classId], references: [id], onDelete: SetNull)

  // Teaching Relations (Teachers)
  teachingSubjects TeacherSubject[]
  teachingClasses  ClassTeacher[]

  // Attendance Relations
  attendanceRecords   Attendance[]        @relation("StudentAttendance")
  attendanceSummaries AttendanceSummary[] @relation("StudentAttendanceSummary")
  markedAttendance    Attendance[]        @relation("AttendanceMarkedBy")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([email])
  @@index([role])
  @@index([classId])
  @@map("users")
}

// ============================================
// SCHOOL MANAGEMENT
// ============================================

model School {
  id     String       @id @default(uuid())
  name   String
  code   String       @unique
  type   SchoolType
  status SchoolStatus @default(ACTIVE)

  // Contact Information
  email   String
  phone   String?
  website String?

  // Address
  address    String
  city       String
  state      String?
  country    String
  postalCode String?

  // Branding
  logo    String?
  motto   String?
  mission String?
  vision  String?

  // Settings
  currency String @default("KES")
  timezone String @default("Africa/Nairobi")
  language String @default("en")

  // Academic
  foundedYear   Int?
  principalName String?

  // Relations
  users         User[]
  departments   Department[]
  academicYears AcademicYear[]
  classes       Class[]
  subjects      Subject[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@map("schools")
}

// ============================================
// DEPARTMENT MANAGEMENT
// ============================================

model Department {
  id          String  @id @default(uuid())
  name        String
  code        String
  description String?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  subjects Subject[]

  // Head of Department
  hodName  String?
  hodEmail String?
  hodPhone String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@map("departments")
}

// ============================================
// ACADEMIC YEAR MANAGEMENT
// ============================================

model AcademicYear {
  id        String   @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  terms   Term[]
  classes Class[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([isCurrent])
  @@map("academic_years")
}

// ============================================
// TERM/SEMESTER MANAGEMENT
// ============================================

model Term {
  id         String   @id @default(uuid())
  name       String
  termNumber Int
  startDate  DateTime
  endDate    DateTime
  isCurrent  Boolean  @default(false)

  // Relations
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([academicYearId])
  @@index([isCurrent])
  @@map("terms")
}

// ============================================
// CLASS MANAGEMENT
// ============================================

model Class {
  id         String  @id @default(uuid())
  name       String
  code       String
  grade      String
  stream     String?
  capacity   Int     @default(40)
  roomNumber String?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  // Students in this class
  students User[] @relation("ClassStudents")

  // Teachers assigned to this class
  teachers ClassTeacher[]

  // Subjects taught in this class
  subjects ClassSubject[]

  // Attendance
  attendance          Attendance[]        @relation("ClassAttendance")
  attendanceSummaries AttendanceSummary[] @relation("ClassAttendanceSummary")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code, academicYearId])
  @@index([schoolId])
  @@index([academicYearId])
  @@map("classes")
}

// ============================================
// SUBJECT MANAGEMENT
// ============================================

model Subject {
  id          String          @id @default(uuid())
  name        String
  code        String
  description String?
  category    SubjectCategory @default(CORE)
  credits     Int?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Classes offering this subject
  classes ClassSubject[]

  // Teachers teaching this subject
  teachers TeacherSubject[]

  // Attendance
  attendance Attendance[] @relation("SubjectAttendance")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([departmentId])
  @@map("subjects")
}

// ============================================
// MANY-TO-MANY RELATIONSHIPS
// ============================================

// Class - Subject relationship
model ClassSubject {
  id String @id @default(uuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  // Additional info
  lessonsPerWeek Int?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, subjectId])
  @@index([classId])
  @@index([subjectId])
  @@map("class_subjects")
}

// Teacher - Subject relationship
model TeacherSubject {
  id String @id @default(uuid())

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  // Additional info
  isPrimary Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

// Class - Teacher relationship
model ClassTeacher {
  id String @id @default(uuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  // Additional info
  isClassTeacher Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
  @@map("class_teachers")
}

// ============================================
// ATTENDANCE MANAGEMENT
// ============================================

// Daily Attendance Record
model Attendance {
  id String @id @default(uuid())

  // Student Information
  studentId String
  student   User   @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)

  // Class Information
  classId String
  class   Class  @relation("ClassAttendance", fields: [classId], references: [id], onDelete: Cascade)

  // Attendance Details
  date    DateTime
  status  AttendanceStatus
  remarks String?

  // Time tracking
  checkInTime  DateTime?
  checkOutTime DateTime?

  // Subject-specific (if period-based)
  subjectId String?
  subject   Subject? @relation("SubjectAttendance", fields: [subjectId], references: [id], onDelete: SetNull)

  // Marked by
  markedById String
  markedBy   User   @relation("AttendanceMarkedBy", fields: [markedById], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId, date, subjectId])
  @@index([studentId])
  @@index([classId])
  @@index([date])
  @@index([status])
  @@map("attendance")
}

// Attendance Summary (for quick stats)
model AttendanceSummary {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentAttendanceSummary", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassAttendanceSummary", fields: [classId], references: [id], onDelete: Cascade)

  // Period (month/term)
  month Int
  year  Int

  // Counts
  totalDays   Int @default(0)
  presentDays Int @default(0)
  absentDays  Int @default(0)
  lateDays    Int @default(0)
  excusedDays Int @default(0)

  // Percentage
  attendanceRate Float @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId, month, year])
  @@index([studentId])
  @@index([classId])
  @@index([year, month])
  @@map("attendance_summaries")
}

// ============================================
// INDEXES FOR PERFORMANCE
// ============================================

// Additional indexes are defined inline above
