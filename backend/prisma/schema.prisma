// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SchoolType {
  PRIMARY
  SECONDARY
  HIGH_SCHOOL
  COLLEGE
  UNIVERSITY
  MIXED
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubjectCategory {
  CORE
  ELECTIVE
  CO_CURRICULAR
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  SICK
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  LATE
  GRADED
}

enum ExamType {
  CAT
  MIDTERM
  FINAL
  PRACTICAL
  QUIZ
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  FILL_IN_BLANK
}

enum ExamStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  GRADED
}

enum GradingScale {
  LETTER // A, B, C, D, F
  PERCENTAGE // 0-100%
  GPA // 0.0-4.0
  POINTS // Custom points
}

enum TermType {
  TERM_1
  TERM_2
  TERM_3
  SEMESTER_1
  SEMESTER_2
  ANNUAL
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String     @id @default(uuid())
  email    String     @unique
  password String
  role     UserRole   @default(STUDENT)
  status   UserStatus @default(PENDING)

  // Personal Information
  firstName   String
  lastName    String
  middleName  String?
  dateOfBirth DateTime?
  gender      Gender?
  phone       String?
  avatar      String?

  // Address
  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String?

  // Security
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  lastLogin       DateTime?
  refreshToken    String?

  // Relations
  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: SetNull)

  // Class Relations (Students)
  classId String?
  class   Class?  @relation("ClassStudents", fields: [classId], references: [id], onDelete: SetNull)

  // Teaching Relations (Teachers)
  teachingSubjects TeacherSubject[]
  teachingClasses  ClassTeacher[]

  // Attendance Relations
  attendanceRecords   Attendance[]        @relation("StudentAttendance")
  attendanceSummaries AttendanceSummary[] @relation("StudentAttendanceSummary")
  markedAttendance    Attendance[]        @relation("AttendanceMarkedBy")

  // Assignment Relations
  createdAssignments Assignment[] @relation("AssignmentCreatedBy")
  submissions        Submission[] @relation("StudentSubmissions")
  gradedSubmissions  Submission[] @relation("SubmissionGradedBy")

  // Examination Relations
  createdExams Exam[]       @relation("ExamCreatedBy")
  examResults  ExamResult[] @relation("StudentExamResults")

  // Grading Relations
  grades      Grade[]      @relation("StudentGrades")
  reportCards ReportCard[] @relation("StudentReportCards")
  transcripts Transcript[] @relation("StudentTranscripts")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([email])
  @@index([role])
  @@index([classId])
  @@map("users")
}

// ============================================
// SCHOOL MANAGEMENT
// ============================================

model School {
  id     String       @id @default(uuid())
  name   String
  code   String       @unique
  type   SchoolType
  status SchoolStatus @default(ACTIVE)

  // Contact Information
  email   String
  phone   String?
  website String?

  // Address
  address    String
  city       String
  state      String?
  country    String
  postalCode String?

  // Branding
  logo    String?
  motto   String?
  mission String?
  vision  String?

  // Settings
  currency String @default("KES")
  timezone String @default("Africa/Nairobi")
  language String @default("en")

  // Academic
  foundedYear   Int?
  principalName String?

  // Relations
  users          User[]
  departments    Department[]
  academicYears  AcademicYear[]
  classes        Class[]
  subjects       Subject[]
  gradingSchemes GradingScheme[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@map("schools")
}

// ============================================
// DEPARTMENT MANAGEMENT
// ============================================

model Department {
  id          String  @id @default(uuid())
  name        String
  code        String
  description String?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  subjects Subject[]

  // Head of Department
  hodName  String?
  hodEmail String?
  hodPhone String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@map("departments")
}

// ============================================
// ACADEMIC YEAR MANAGEMENT
// ============================================

model AcademicYear {
  id        String   @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  terms       Term[]
  classes     Class[]
  grades      Grade[]
  reportCards ReportCard[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([isCurrent])
  @@map("academic_years")
}

// ============================================
// TERM/SEMESTER MANAGEMENT
// ============================================

model Term {
  id         String   @id @default(uuid())
  name       String
  termNumber Int
  startDate  DateTime
  endDate    DateTime
  isCurrent  Boolean  @default(false)

  // Relations
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  grades      Grade[]
  reportCards ReportCard[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([academicYearId])
  @@index([isCurrent])
  @@map("terms")
}

// ============================================
// CLASS MANAGEMENT
// ============================================

model Class {
  id         String  @id @default(uuid())
  name       String
  code       String
  grade      String
  stream     String?
  capacity   Int     @default(40)
  roomNumber String?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  // Students in this class
  students User[] @relation("ClassStudents")

  // Teachers assigned to this class
  teachers ClassTeacher[]

  // Subjects taught in this class
  subjects ClassSubject[]

  // Attendance
  attendance          Attendance[]        @relation("ClassAttendance")
  attendanceSummaries AttendanceSummary[] @relation("ClassAttendanceSummary")

  // Assignments
  assignments Assignment[] @relation("ClassAssignments")

  // Exams
  exams Exam[] @relation("ClassExams")

  // Grading
  grades      Grade[]      @relation("ClassGrades")
  reportCards ReportCard[] @relation("ClassReportCards")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code, academicYearId])
  @@index([schoolId])
  @@index([academicYearId])
  @@map("classes")
}

// ============================================
// SUBJECT MANAGEMENT
// ============================================

model Subject {
  id          String          @id @default(uuid())
  name        String
  code        String
  description String?
  category    SubjectCategory @default(CORE)
  credits     Int?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Classes offering this subject
  classes ClassSubject[]

  // Teachers teaching this subject
  teachers TeacherSubject[]

  // Attendance
  attendance Attendance[] @relation("SubjectAttendance")

  // Assignments
  assignments Assignment[] @relation("SubjectAssignments")

  // Exams
  exams Exam[] @relation("SubjectExams")

  // Grading
  grades Grade[] @relation("SubjectGrades")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([departmentId])
  @@map("subjects")
}

// ============================================
// MANY-TO-MANY RELATIONSHIPS
// ============================================

model ClassSubject {
  id String @id @default(uuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  lessonsPerWeek Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, subjectId])
  @@index([classId])
  @@index([subjectId])
  @@map("class_subjects")
}

model TeacherSubject {
  id String @id @default(uuid())

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

model ClassTeacher {
  id String @id @default(uuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  isClassTeacher Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
  @@map("class_teachers")
}

// ============================================
// ATTENDANCE MANAGEMENT
// ============================================

model Attendance {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassAttendance", fields: [classId], references: [id], onDelete: Cascade)

  date    DateTime
  status  AttendanceStatus
  remarks String?

  checkInTime  DateTime?
  checkOutTime DateTime?

  subjectId String?
  subject   Subject? @relation("SubjectAttendance", fields: [subjectId], references: [id], onDelete: SetNull)

  markedById String
  markedBy   User   @relation("AttendanceMarkedBy", fields: [markedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId, date, subjectId])
  @@index([studentId])
  @@index([classId])
  @@index([date])
  @@index([status])
  @@map("attendance")
}

model AttendanceSummary {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentAttendanceSummary", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassAttendanceSummary", fields: [classId], references: [id], onDelete: Cascade)

  month Int
  year  Int

  totalDays   Int @default(0)
  presentDays Int @default(0)
  absentDays  Int @default(0)
  lateDays    Int @default(0)
  excusedDays Int @default(0)

  attendanceRate Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId, month, year])
  @@index([studentId])
  @@index([classId])
  @@index([year, month])
  @@map("attendance_summaries")
}

// ============================================
// ASSIGNMENT & SUBMISSION MANAGEMENT
// ============================================

model Assignment {
  id String @id @default(uuid())

  title        String
  description  String?
  instructions String?

  totalPoints         Int      @default(100)
  passingPoints       Int?
  dueDate             DateTime
  allowLateSubmission Boolean  @default(true)
  latePenalty         Float?

  status AssignmentStatus @default(DRAFT)

  classId String
  class   Class  @relation("ClassAssignments", fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("SubjectAssignments", fields: [subjectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("AssignmentCreatedBy", fields: [createdById], references: [id])

  attachments String[]

  submissions Submission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
  @@index([subjectId])
  @@index([status])
  @@index([dueDate])
  @@map("assignments")
}

model Submission {
  id String @id @default(uuid())

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)

  status      SubmissionStatus @default(NOT_SUBMITTED)
  content     String?
  attachments String[]

  submittedAt DateTime?
  isLate      Boolean   @default(false)

  points     Int?
  feedback   String?
  gradedAt   DateTime?
  gradedById String?
  gradedBy   User?     @relation("SubmissionGradedBy", fields: [gradedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@map("submissions")
}

// ============================================
// EXAMINATION SYSTEM
// ============================================

model Exam {
  id           String  @id @default(uuid())
  title        String
  description  String?
  instructions String?

  // Exam Details
  examType     ExamType
  totalMarks   Int      @default(100)
  passingMarks Int?
  duration     Int // Duration in minutes

  startTime DateTime
  endTime   DateTime

  status ExamStatus @default(DRAFT)

  // Settings
  shuffleQuestions Boolean @default(false)
  showResults      Boolean @default(false)
  allowReview      Boolean @default(true)

  // Relations
  classId String
  class   Class  @relation("ClassExams", fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("SubjectExams", fields: [subjectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("ExamCreatedBy", fields: [createdById], references: [id])

  // Questions and Results
  questions ExamQuestion[]
  results   ExamResult[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
  @@index([subjectId])
  @@index([status])
  @@index([startTime])
  @@map("exams")
}

model ExamQuestion {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  questionType QuestionType
  questionText String
  marks        Int          @default(1)
  order        Int

  // For Multiple Choice
  options       String[] // Array of options
  correctAnswer String? // For objective questions

  // For descriptive
  sampleAnswer String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers ExamAnswer[]

  @@index([examId])
  @@map("exam_questions")
}

model ExamResult {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation("StudentExamResults", fields: [studentId], references: [id], onDelete: Cascade)

  // Result Details
  startedAt   DateTime?
  submittedAt DateTime?
  duration    Int? // Actual time taken in minutes

  score      Int     @default(0)
  totalMarks Int
  percentage Float   @default(0)
  grade      String?

  passed Boolean @default(false)

  // Answers
  answers ExamAnswer[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@map("exam_results")
}

model ExamAnswer {
  id String @id @default(uuid())

  resultId String
  result   ExamResult @relation(fields: [resultId], references: [id], onDelete: Cascade)

  questionId String
  question   ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  answer        String?
  isCorrect     Boolean?
  marksObtained Int      @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resultId])
  @@index([questionId])
  @@map("exam_answers")
}

// ============================================
// GRADING SYSTEM
// ============================================

model GradingScheme {
  id          String       @id @default(uuid())
  name        String
  description String?
  scale       GradingScale @default(LETTER)
  isDefault   Boolean      @default(false)

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  boundaries GradeBoundary[]
  grades     Grade[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@map("grading_schemes")
}

model GradeBoundary {
  id String @id @default(uuid())

  schemeId String
  scheme   GradingScheme @relation(fields: [schemeId], references: [id], onDelete: Cascade)

  grade       String // A, B, C, etc.
  minScore    Float
  maxScore    Float
  gradePoint  Float? // For GPA calculation
  description String? // Excellent, Good, Fair, etc.
  passStatus  Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schemeId])
  @@map("grade_boundaries")
}

model Grade {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentGrades", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassGrades", fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("SubjectGrades", fields: [subjectId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  termId String?
  term   Term?   @relation(fields: [termId], references: [id], onDelete: SetNull)

  termType TermType

  // Grading Scheme
  schemeId String?
  scheme   GradingScheme? @relation(fields: [schemeId], references: [id], onDelete: SetNull)

  // Scores
  assignmentScore Float   @default(0)
  examScore       Float   @default(0)
  totalScore      Float   @default(0)
  maxScore        Float   @default(100)
  percentage      Float   @default(0)
  letterGrade     String? // A, B, C, etc.
  gradePoint      Float? // For GPA
  remarks         String?

  // Status
  isPassed Boolean @default(false)
  isLocked Boolean @default(false) // Prevent changes after report card generation
  position Int? // Class position
  outOf    Int? // Total students

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, subjectId, academicYearId, termType])
  @@index([studentId])
  @@index([classId])
  @@index([subjectId])
  @@index([academicYearId])
  @@index([termId])
  @@map("grades")
}

model ReportCard {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentReportCards", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassReportCards", fields: [classId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  termId String?
  term   Term?   @relation(fields: [termId], references: [id], onDelete: SetNull)

  termType TermType

  // Overall Performance
  totalMarks   Float   @default(0)
  maxMarks     Float   @default(0)
  averageScore Float   @default(0)
  overallGrade String?
  overallGPA   Float?
  position     Int?
  outOf        Int?
  promoted     Boolean @default(false)

  // Attendance Summary
  totalDays      Int   @default(0)
  daysPresent    Int   @default(0)
  daysAbsent     Int   @default(0)
  attendanceRate Float @default(0)

  // Comments
  classTeacherComment String?
  principalComment    String?

  // Status
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  generatedBy String?

  // PDF
  pdfUrl String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, academicYearId, termType])
  @@index([studentId])
  @@index([classId])
  @@index([academicYearId])
  @@index([termId])
  @@map("report_cards")
}

model Transcript {
  id String @id @default(uuid())

  studentId String @unique
  student   User   @relation("StudentTranscripts", fields: [studentId], references: [id], onDelete: Cascade)

  // Cumulative Data
  totalCredits  Float   @default(0)
  earnedCredits Float   @default(0)
  cumulativeGPA Float   @default(0)
  overallGrade  String?

  // Academic Summary
  yearsCompleted Int @default(0)
  termsCompleted Int @default(0)

  // Status
  isComplete     Boolean   @default(false)
  graduationDate DateTime?

  // PDF
  pdfUrl String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@map("transcripts")
}
