// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum SchoolType {
  PRIMARY
  SECONDARY
  HIGH_SCHOOL
  COLLEGE
  UNIVERSITY
  MIXED
}

enum SchoolStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubjectCategory {
  CORE
  ELECTIVE
  CO_CURRICULAR
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  SICK
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  LATE
  GRADED
}

enum ExamType {
  CAT
  MIDTERM
  FINAL
  PRACTICAL
  QUIZ
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
  FILL_IN_BLANK
}

enum ExamStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  GRADED
}

enum GradingScale {
  LETTER
  PERCENTAGE
  GPA
  POINTS
}

enum TermType {
  TERM_1
  TERM_2
  TERM_3
  SEMESTER_1
  SEMESTER_2
  ANNUAL
}

enum AnalyticsType {
  STUDENT_PERFORMANCE
  CLASS_PERFORMANCE
  SUBJECT_PERFORMANCE
  ATTENDANCE_TREND
  ASSIGNMENT_COMPLETION
  EXAM_RESULTS
}

enum NotificationType {
  ANNOUNCEMENT
  ASSIGNMENT_CREATED
  ASSIGNMENT_GRADED
  EXAM_SCHEDULED
  EXAM_GRADED
  ATTENDANCE_ALERT
  REPORT_CARD_PUBLISHED
  FEE_REMINDER
  GENERAL
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum FeeCategory {
  TUITION
  BOARDING
  TRANSPORT
  EXAMINATION
  LIBRARY
  SPORTS
  ACTIVITY
  OTHER
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  MOBILE_MONEY
  CARD
  CHEQUE
}

// ============================================
// USER MANAGEMENT
// ============================================

model User {
  id       String     @id @default(uuid())
  email    String     @unique
  password String
  role     UserRole   @default(STUDENT)
  status   UserStatus @default(PENDING)

  // Personal Information
  firstName   String
  lastName    String
  middleName  String?
  dateOfBirth DateTime?
  gender      Gender?
  phone       String?
  avatar      String?

  // Address
  address    String?
  city       String?
  state      String?
  country    String?
  postalCode String?

  // Security
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  lastLogin       DateTime?
  refreshToken    String?

  // Relations
  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: SetNull)

  // Class Relations (Students)
  classId String?
  class   Class?  @relation("ClassStudents", fields: [classId], references: [id], onDelete: SetNull)

  // Teaching Relations (Teachers)
  teachingSubjects TeacherSubject[]
  teachingClasses  ClassTeacher[]

  // Attendance Relations
  attendanceRecords   Attendance[]        @relation("StudentAttendance")
  attendanceSummaries AttendanceSummary[] @relation("StudentAttendanceSummary")
  markedAttendance    Attendance[]        @relation("AttendanceMarkedBy")

  // Assignment Relations
  createdAssignments Assignment[] @relation("AssignmentCreatedBy")
  submissions        Submission[] @relation("StudentSubmissions")
  gradedSubmissions  Submission[] @relation("SubmissionGradedBy")

  // Examination Relations
  createdExams Exam[]       @relation("ExamCreatedBy")
  examResults  ExamResult[] @relation("StudentExamResults")

  // Grading Relations
  grades      Grade[]      @relation("StudentGrades")
  reportCards ReportCard[] @relation("StudentReportCards")
  transcripts Transcript[] @relation("StudentTranscripts")

  // Analytics Relations
  analytics Analytics[] @relation("StudentAnalytics")

  // Notification Relations
  receivedNotifications Notification[] @relation("ReceivedNotifications")
  sentNotifications     Notification[] @relation("SentNotifications")

  // Communication Relations
  createdAnnouncements Announcement[] @relation("AnnouncementsCreated")
  sentMessages         Message[]      @relation("MessagesSent")
  receivedMessages     Message[]      @relation("MessagesReceived")

  // Financial Relations
  feeAssignments FeeAssignment[] @relation("StudentFeeAssignments")
  payments       Payment[]       @relation("StudentPayments")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([email])
  @@index([role])
  @@index([classId])
  @@map("users")
}

// ============================================
// SCHOOL MANAGEMENT
// ============================================

model School {
  id     String       @id @default(uuid())
  name   String
  code   String       @unique
  type   SchoolType
  status SchoolStatus @default(ACTIVE)

  // Contact Information
  email   String
  phone   String?
  website String?

  // Address
  address    String
  city       String
  state      String?
  country    String
  postalCode String?

  // Branding
  logo    String?
  motto   String?
  mission String?
  vision  String?

  // Settings
  currency String @default("KES")
  timezone String @default("Africa/Nairobi")
  language String @default("en")

  // Academic
  foundedYear   Int?
  principalName String?

  // Relations
  users          User[]
  departments    Department[]
  academicYears  AcademicYear[]
  classes        Class[]
  subjects       Subject[]
  gradingSchemes GradingScheme[]
  analytics      Analytics[]
  notifications  Notification[]
  announcements  Announcement[]
  feeStructures  FeeStructure[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([status])
  @@map("schools")
}

// ============================================
// DEPARTMENT MANAGEMENT
// ============================================

model Department {
  id          String  @id @default(uuid())
  name        String
  code        String
  description String?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  subjects Subject[]

  // Head of Department
  hodName  String?
  hodEmail String?
  hodPhone String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@map("departments")
}

// ============================================
// ACADEMIC YEAR MANAGEMENT
// ============================================

model AcademicYear {
  id        String   @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  terms       Term[]
  classes     Class[]
  grades      Grade[]
  reportCards ReportCard[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([isCurrent])
  @@map("academic_years")
}

// ============================================
// TERM/SEMESTER MANAGEMENT
// ============================================

model Term {
  id         String   @id @default(uuid())
  name       String
  termNumber Int
  startDate  DateTime
  endDate    DateTime
  isCurrent  Boolean  @default(false)

  // Relations
  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  grades      Grade[]
  reportCards ReportCard[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([academicYearId])
  @@index([isCurrent])
  @@map("terms")
}

// ============================================
// CLASS MANAGEMENT
// ============================================

model Class {
  id         String  @id @default(uuid())
  name       String
  code       String
  grade      String
  stream     String?
  capacity   Int     @default(40)
  roomNumber String?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  // Students in this class
  students User[] @relation("ClassStudents")

  // Teachers assigned to this class
  teachers ClassTeacher[]

  // Subjects taught in this class
  subjects ClassSubject[]

  // Attendance
  attendance          Attendance[]        @relation("ClassAttendance")
  attendanceSummaries AttendanceSummary[] @relation("ClassAttendanceSummary")

  // Assignments
  assignments Assignment[] @relation("ClassAssignments")

  // Exams
  exams Exam[] @relation("ClassExams")

  // Grading
  grades      Grade[]      @relation("ClassGrades")
  reportCards ReportCard[] @relation("ClassReportCards")

  // Analytics & Communication
  analytics     Analytics[]
  notifications Notification[]
  announcements Announcement[]

  // Fee Assignments
  feeAssignments FeeAssignment[] @relation("ClassFeeAssignments")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code, academicYearId])
  @@index([schoolId])
  @@index([academicYearId])
  @@map("classes")
}

// ============================================
// SUBJECT MANAGEMENT
// ============================================

model Subject {
  id          String          @id @default(uuid())
  name        String
  code        String
  description String?
  category    SubjectCategory @default(CORE)
  credits     Int?

  // Relations
  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  // Classes offering this subject
  classes ClassSubject[]

  // Teachers teaching this subject
  teachers TeacherSubject[]

  // Attendance
  attendance Attendance[] @relation("SubjectAttendance")

  // Assignments
  assignments Assignment[] @relation("SubjectAssignments")

  // Exams
  exams Exam[] @relation("SubjectExams")

  // Grading
  grades Grade[] @relation("SubjectGrades")

  // Analytics
  analytics Analytics[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([departmentId])
  @@map("subjects")
}

// ============================================
// MANY-TO-MANY RELATIONSHIPS
// ============================================

model ClassSubject {
  id String @id @default(uuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  lessonsPerWeek Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, subjectId])
  @@index([classId])
  @@index([subjectId])
  @@map("class_subjects")
}

model TeacherSubject {
  id String @id @default(uuid())

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

model ClassTeacher {
  id String @id @default(uuid())

  classId String
  class   Class  @relation(fields: [classId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  isClassTeacher Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
  @@map("class_teachers")
}

// ============================================
// ATTENDANCE MANAGEMENT
// ============================================

model Attendance {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassAttendance", fields: [classId], references: [id], onDelete: Cascade)

  date    DateTime
  status  AttendanceStatus
  remarks String?

  checkInTime  DateTime?
  checkOutTime DateTime?

  subjectId String?
  subject   Subject? @relation("SubjectAttendance", fields: [subjectId], references: [id], onDelete: SetNull)

  markedById String
  markedBy   User   @relation("AttendanceMarkedBy", fields: [markedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId, date, subjectId])
  @@index([studentId])
  @@index([classId])
  @@index([date])
  @@index([status])
  @@map("attendance")
}

model AttendanceSummary {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentAttendanceSummary", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassAttendanceSummary", fields: [classId], references: [id], onDelete: Cascade)

  month Int
  year  Int

  totalDays   Int @default(0)
  presentDays Int @default(0)
  absentDays  Int @default(0)
  lateDays    Int @default(0)
  excusedDays Int @default(0)

  attendanceRate Float @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, classId, month, year])
  @@index([studentId])
  @@index([classId])
  @@index([year, month])
  @@map("attendance_summaries")
}

// ============================================
// ASSIGNMENT & SUBMISSION MANAGEMENT
// ============================================

model Assignment {
  id String @id @default(uuid())

  title        String
  description  String?
  instructions String?

  totalPoints         Int      @default(100)
  passingPoints       Int?
  dueDate             DateTime
  allowLateSubmission Boolean  @default(true)
  latePenalty         Float?

  status AssignmentStatus @default(DRAFT)

  classId String
  class   Class  @relation("ClassAssignments", fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("SubjectAssignments", fields: [subjectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("AssignmentCreatedBy", fields: [createdById], references: [id])

  attachments String[]

  submissions Submission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
  @@index([subjectId])
  @@index([status])
  @@index([dueDate])
  @@map("assignments")
}

model Submission {
  id String @id @default(uuid())

  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)

  status      SubmissionStatus @default(NOT_SUBMITTED)
  content     String?
  attachments String[]

  submittedAt DateTime?
  isLate      Boolean   @default(false)

  points     Int?
  feedback   String?
  gradedAt   DateTime?
  gradedById String?
  gradedBy   User?     @relation("SubmissionGradedBy", fields: [gradedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@map("submissions")
}

// ============================================
// EXAMINATION SYSTEM
// ============================================

model Exam {
  id           String  @id @default(uuid())
  title        String
  description  String?
  instructions String?

  examType     ExamType
  totalMarks   Int      @default(100)
  passingMarks Int?
  duration     Int

  startTime DateTime
  endTime   DateTime

  status ExamStatus @default(DRAFT)

  shuffleQuestions Boolean @default(false)
  showResults      Boolean @default(false)
  allowReview      Boolean @default(true)

  classId String
  class   Class  @relation("ClassExams", fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("SubjectExams", fields: [subjectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("ExamCreatedBy", fields: [createdById], references: [id])

  questions ExamQuestion[]
  results   ExamResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([classId])
  @@index([subjectId])
  @@index([status])
  @@index([startTime])
  @@map("exams")
}

model ExamQuestion {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  questionType  QuestionType
  questionText  String
  marks         Int          @default(1)
  order         Int
  options       String[]
  correctAnswer String?
  sampleAnswer  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  answers ExamAnswer[]

  @@index([examId])
  @@map("exam_questions")
}

model ExamResult {
  id String @id @default(uuid())

  examId String
  exam   Exam   @relation(fields: [examId], references: [id], onDelete: Cascade)

  studentId String
  student   User   @relation("StudentExamResults", fields: [studentId], references: [id], onDelete: Cascade)

  startedAt   DateTime?
  submittedAt DateTime?
  duration    Int?

  score      Int     @default(0)
  totalMarks Int
  percentage Float   @default(0)
  grade      String?
  passed     Boolean @default(false)

  answers ExamAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examId, studentId])
  @@index([examId])
  @@index([studentId])
  @@map("exam_results")
}

model ExamAnswer {
  id String @id @default(uuid())

  resultId String
  result   ExamResult @relation(fields: [resultId], references: [id], onDelete: Cascade)

  questionId String
  question   ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  answer        String?
  isCorrect     Boolean?
  marksObtained Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([resultId])
  @@index([questionId])
  @@map("exam_answers")
}

// ============================================
// GRADING SYSTEM
// ============================================

model GradingScheme {
  id          String       @id @default(uuid())
  name        String
  description String?
  scale       GradingScale @default(LETTER)
  isDefault   Boolean      @default(false)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  boundaries GradeBoundary[]
  grades     Grade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@map("grading_schemes")
}

model GradeBoundary {
  id String @id @default(uuid())

  schemeId String
  scheme   GradingScheme @relation(fields: [schemeId], references: [id], onDelete: Cascade)

  grade       String
  minScore    Float
  maxScore    Float
  gradePoint  Float?
  description String?
  passStatus  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schemeId])
  @@map("grade_boundaries")
}

model Grade {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentGrades", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassGrades", fields: [classId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation("SubjectGrades", fields: [subjectId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  termId   String?
  term     Term?    @relation(fields: [termId], references: [id], onDelete: SetNull)
  termType TermType

  schemeId String?
  scheme   GradingScheme? @relation(fields: [schemeId], references: [id], onDelete: SetNull)

  assignmentScore Float   @default(0)
  examScore       Float   @default(0)
  totalScore      Float   @default(0)
  maxScore        Float   @default(100)
  percentage      Float   @default(0)
  letterGrade     String?
  gradePoint      Float?
  remarks         String?

  isPassed Boolean @default(false)
  isLocked Boolean @default(false)
  position Int?
  outOf    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, subjectId, academicYearId, termType])
  @@index([studentId])
  @@index([classId])
  @@index([subjectId])
  @@index([academicYearId])
  @@index([termId])
  @@map("grades")
}

model ReportCard {
  id String @id @default(uuid())

  studentId String
  student   User   @relation("StudentReportCards", fields: [studentId], references: [id], onDelete: Cascade)

  classId String
  class   Class  @relation("ClassReportCards", fields: [classId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  termId   String?
  term     Term?    @relation(fields: [termId], references: [id], onDelete: SetNull)
  termType TermType

  totalMarks   Float   @default(0)
  maxMarks     Float   @default(0)
  averageScore Float   @default(0)
  overallGrade String?
  overallGPA   Float?
  position     Int?
  outOf        Int?
  promoted     Boolean @default(false)

  totalDays      Int   @default(0)
  daysPresent    Int   @default(0)
  daysAbsent     Int   @default(0)
  attendanceRate Float @default(0)

  classTeacherComment String?
  principalComment    String?

  isPublished Boolean   @default(false)
  publishedAt DateTime?
  generatedBy String?
  pdfUrl      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, academicYearId, termType])
  @@index([studentId])
  @@index([classId])
  @@index([academicYearId])
  @@index([termId])
  @@map("report_cards")
}

model Transcript {
  id String @id @default(uuid())

  studentId String @unique
  student   User   @relation("StudentTranscripts", fields: [studentId], references: [id], onDelete: Cascade)

  totalCredits  Float   @default(0)
  earnedCredits Float   @default(0)
  cumulativeGPA Float   @default(0)
  overallGrade  String?

  yearsCompleted Int @default(0)
  termsCompleted Int @default(0)

  isComplete     Boolean   @default(false)
  graduationDate DateTime?
  pdfUrl         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@map("transcripts")
}

// ============================================
// ANALYTICS SYSTEM
// ============================================

model Analytics {
  id String @id @default(uuid())

  type        AnalyticsType
  title       String
  description String?

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id], onDelete: Cascade)

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  studentId String?
  student   User?   @relation("StudentAnalytics", fields: [studentId], references: [id], onDelete: Cascade)

  data Json

  startDate DateTime
  endDate   DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([classId])
  @@index([subjectId])
  @@index([studentId])
  @@index([type])
  @@map("analytics")
}

// ============================================
// NOTIFICATION & COMMUNICATION SYSTEM
// ============================================

model Notification {
  id String @id @default(uuid())

  type    NotificationType
  channel NotificationChannel @default(IN_APP)
  status  NotificationStatus  @default(UNREAD)

  title   String
  message String
  link    String?

  recipientId String
  recipient   User   @relation("ReceivedNotifications", fields: [recipientId], references: [id], onDelete: Cascade)

  senderId String?
  sender   User?   @relation("SentNotifications", fields: [senderId], references: [id], onDelete: SetNull)

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id], onDelete: Cascade)

  metadata Json?
  readAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipientId])
  @@index([senderId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("notifications")
}

model Announcement {
  id String @id @default(uuid())

  title   String
  content String

  schoolId String?
  school   School? @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classId String?
  class   Class?  @relation(fields: [classId], references: [id], onDelete: Cascade)

  targetRoles UserRole[]
  isPublic    Boolean    @default(false)
  priority    String     @default("NORMAL")

  createdById String
  createdBy   User   @relation("AnnouncementsCreated", fields: [createdById], references: [id])

  isActive Boolean @default(true)

  publishAt DateTime?
  expiresAt DateTime?

  attachments String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@index([classId])
  @@index([createdById])
  @@index([isActive])
  @@map("announcements")
}

model Message {
  id String @id @default(uuid())

  subject String?
  content String

  senderId String
  sender   User   @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)

  recipientId String
  recipient   User   @relation("MessagesReceived", fields: [recipientId], references: [id], onDelete: Cascade)

  threadId String?
  thread   Message?  @relation("MessageThread", fields: [threadId], references: [id], onDelete: Cascade)
  replies  Message[] @relation("MessageThread")

  isRead    Boolean   @default(false)
  readAt    DateTime?
  isStarred Boolean   @default(false)

  attachments String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([senderId])
  @@index([recipientId])
  @@index([threadId])
  @@index([isRead])
  @@map("messages")
}

// ============================================
// FINANCIAL MANAGEMENT SYSTEM
// ============================================

// Fee Structures
model FeeStructure {
  id          String          @id @default(uuid())
  name        String
  description String?
  category    FeeCategory
  amount      Float
  isOptional  Boolean         @default(false)
  isRecurring Boolean         @default(true) // Per term/year
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignments FeeAssignment[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([schoolId])
  @@index([category])
  @@map("fee_structures")
}

model FeeAssignment {
  id             String        @id @default(uuid())
  studentId      String
  student        User          @relation("StudentFeeAssignments", fields: [studentId], references: [id], onDelete: Cascade)
  classId        String?
  class          Class?        @relation("ClassFeeAssignments", fields: [classId], references: [id], onDelete: SetNull)
  feeStructureId String
  feeStructure   FeeStructure  @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  // Amount details
  totalAmount    Float
  paidAmount     Float         @default(0)
  balance        Float
  discountAmount Float         @default(0)
  discountReason String?
  // Status
  status         PaymentStatus @default(PENDING)
  // Due date
  dueDate        DateTime
  // Academic period
  academicYear   String?
  term           String?
  payments       Payment[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([studentId])
  @@index([classId])
  @@index([feeStructureId])
  @@index([status])
  @@index([dueDate])
  @@map("fee_assignments")
}

model Payment {
  id              String        @id @default(uuid())
  studentId       String
  student         User          @relation("StudentPayments", fields: [studentId], references: [id], onDelete: Cascade)
  feeAssignmentId String
  feeAssignment   FeeAssignment @relation(fields: [feeAssignmentId], references: [id], onDelete: Cascade)
  // Payment details
  amount          Float
  paymentMethod   PaymentMethod
  paymentDate     DateTime      @default(now())
  transactionRef  String?       @unique
  paymentStatus   PaymentStatus @default(PAID)
  // Bank/Mobile details
  bankName        String?
  accountNumber   String?
  chequeNumber    String?
  mobileNumber    String?
  // Receipt
  receiptNumber   String        @unique
  receiptUrl      String?
  // Notes
  notes           String?
  // Processed by
  processedBy     String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([studentId])
  @@index([feeAssignmentId])
  @@index([paymentDate])
  @@index([paymentStatus])
  @@map("payments")
}

// ============================================
// END OF SCHEMA
// ============================================

// Recent Edits Summary:
// - Added financial management models: FeeStructure, FeeAssignment, Payment.
// - Established relationships between users, classes, and fee assignments.
//- Included payment details and statuses.
//- Indexed relevant fields for efficient querying.
// ============================================

// END OF FILE
